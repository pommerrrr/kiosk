<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Centro de Custo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="costManagement()" x-cloak>
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <i class="fas fa-building text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Centro de Custo</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" x-text="getCurrentMonth()"></span>
                    <button 
                        @click="closeMonth()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                    >
                        <i class="fas fa-calendar mr-2"></i>Fechar Mês
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Navigation -->
        <div class="mb-8">
            <nav class="flex space-x-4">
                <button 
                    @click="currentView = 'dashboard'" 
                    :class="currentView === 'dashboard' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                    class="px-4 py-2 rounded-lg font-medium transition-colors"
                >
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button 
                    @click="currentView = 'employees'" 
                    :class="currentView === 'employees' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                    class="px-4 py-2 rounded-lg font-medium transition-colors"
                >
                    <i class="fas fa-users mr-2"></i>Funcionários
                </button>
                <button 
                    @click="currentView = 'history'" 
                    :class="currentView === 'history' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                    class="px-4 py-2 rounded-lg font-medium transition-colors"
                >
                    <i class="fas fa-history mr-2"></i>Histórico
                </button>
            </nav>
        </div>

        <!-- Dashboard View -->
        <div x-show="currentView === 'dashboard'" class="space-y-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Vendas Totais</p>
                            <p class="text-2xl font-bold text-green-600" x-text="formatCurrency(getTotalSales())"></p>
                        </div>
                        <i class="fas fa-dollar-sign text-green-600 text-2xl"></i>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Custos Totais</p>
                            <p class="text-2xl font-bold text-red-600" x-text="formatCurrency(getTotalCosts())"></p>
                        </div>
                        <i class="fas fa-shopping-cart text-red-600 text-2xl"></i>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Mão de Obra</p>
                            <p class="text-2xl font-bold text-blue-600" x-text="formatCurrency(getTotalLaborCost())"></p>
                        </div>
                        <i class="fas fa-users text-blue-600 text-2xl"></i>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Lucro/Prejuízo</p>
                            <p class="text-2xl font-bold" 
                               :class="getProfit() >= 0 ? 'text-green-600' : 'text-red-600'"
                               x-text="formatCurrency(getProfit())"></p>
                        </div>
                        <i class="fas fa-chart-line text-2xl" 
                           :class="getProfit() >= 0 ? 'text-green-600' : 'text-red-600'"></i>
                    </div>
                </div>
            </div>

            <!-- Cost Centers Summary Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 bg-gray-50 border-b">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="fas fa-table mr-2 text-blue-600"></i>
                        Totalizadores por Centro de Custo
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Centro</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Compras</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Custos Fixos</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mão de Obra</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Custos</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lucro/Prejuízo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Margem %</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="center in costCenters" :key="center.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="h-4 w-4 rounded-full mr-3" 
                                                 :style="'background-color: ' + getCenterColor(center.id)"></div>
                                            <span class="text-sm font-medium text-gray-900" x-text="center.name"></span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium" 
                                        x-text="formatCurrency(getCenterSales(center))"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600" 
                                        x-text="formatCurrency(getCenterPurchases(center))"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-600" 
                                        x-text="formatCurrency(getCenterFixedCosts(center))"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600" 
                                        x-text="formatCurrency(getCenterLaborCost(center))"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium" 
                                        x-text="formatCurrency(getCenterTotalCosts(center))"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold" 
                                        :class="getCenterProfit(center) >= 0 ? 'text-green-600' : 'text-red-600'"
                                        x-text="formatCurrency(getCenterProfit(center))"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm" 
                                        :class="getCenterMargin(center) >= 0 ? 'text-green-600' : 'text-red-600'"
                                        x-text="getCenterMargin(center).toFixed(1) + '%'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button @click="editCenter(center)" 
                                                class="bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 transition-colors">
                                            <i class="fas fa-edit mr-1"></i>Editar
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <!-- Total Row -->
                            <tr class="bg-gray-50 font-semibold">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">TOTAL GERAL</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600" 
                                    x-text="formatCurrency(getTotalSales())"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600" 
                                    x-text="formatCurrency(getTotalPurchases())"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-600" 
                                    x-text="formatCurrency(getTotalFixedCosts())"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600" 
                                    x-text="formatCurrency(getTotalLaborCost())"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600" 
                                    x-text="formatCurrency(getTotalCosts() + getTotalLaborCost())"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold" 
                                    :class="getProfit() >= 0 ? 'text-green-600' : 'text-red-600'"
                                    x-text="formatCurrency(getProfit())"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm" 
                                    :class="getProfit() >= 0 ? 'text-green-600' : 'text-red-600'"
                                    x-text="((getProfit() / getTotalSales()) * 100).toFixed(1) + '%'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Cost Centers Cards -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <template x-for="center in costCenters" :key="center.id">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <div class="h-4 w-4 rounded-full mr-3" 
                                     :style="'background-color: ' + getCenterColor(center.id)"></div>
                                <h3 class="text-lg font-semibold" x-text="center.name"></h3>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-medium"
                                  :class="getCenterProfit(center) >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                  x-text="formatCurrency(getCenterProfit(center))">
                            </span>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Vendas:</span>
                                <span class="text-green-600 font-medium" x-text="formatCurrency(getCenterSales(center))"></span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Compras:</span>
                                <span class="text-red-600 font-medium" x-text="formatCurrency(getCenterPurchases(center))"></span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Custos Fixos:</span>
                                <span class="text-orange-600 font-medium" x-text="formatCurrency(getCenterFixedCosts(center))"></span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Mão de Obra:</span>
                                <span class="text-blue-600 font-medium" x-text="formatCurrency(getCenterLaborCost(center))"></span>
                            </div>
                            <div class="flex justify-between text-sm pt-2 border-t">
                                <span class="text-gray-900 font-medium">Margem:</span>
                                <span class="font-bold" 
                                      :class="getCenterMargin(center) >= 0 ? 'text-green-600' : 'text-red-600'"
                                      x-text="getCenterMargin(center).toFixed(1) + '%'"></span>
                            </div>
                        </div>
                        
                        <button @click="editCenter(center)" 
                                class="w-full mt-4 bg-blue-50 text-blue-600 py-2 rounded-lg hover:bg-blue-100 transition-colors">
                            <i class="fas fa-edit mr-2"></i>Gerenciar Centro
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Employees View -->
        <div x-show="currentView === 'employees'" class="space-y-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold">Funcionários</h2>
                    <p class="text-gray-600">Gerencie salários e distribuição por centro de custo</p>
                </div>
                <button @click="addEmployee()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>Adicionar
                </button>
            </div>

            <!-- Summary Card -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Funcionários</p>
                            <p class="text-2xl font-bold text-blue-600" x-text="employees.length"></p>
                        </div>
                        <i class="fas fa-users text-blue-600 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Folha de Pagamento</p>
                            <p class="text-2xl font-bold text-green-600" x-text="formatCurrency(getTotalLaborCost())"></p>
                        </div>
                        <i class="fas fa-dollar-sign text-green-600 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Salário Médio</p>
                            <p class="text-2xl font-bold text-gray-700" 
                               x-text="formatCurrency(employees.length > 0 ? getTotalLaborCost() / employees.length : 0)"></p>
                        </div>
                        <i class="fas fa-chart-bar text-gray-700 text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <template x-for="(employee, index) in employees" :key="index">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold" x-text="employee.name"></h3>
                                <span class="text-sm text-gray-600" x-text="formatCurrency(employee.salary)"></span>
                            </div>
                            <div class="flex space-x-2">
                                <button @click="editEmployeeDistribution(index)" 
                                        class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200">
                                    <i class="fas fa-percentage mr-1"></i>Distribuição
                                </button>
                                <button @click="editEmployee(index)" 
                                        class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-200">
                                    <i class="fas fa-edit mr-1"></i>Editar
                                </button>
                                <button @click="removeEmployee(index)" 
                                        class="bg-red-100 text-red-700 px-3 py-1 rounded text-sm hover:bg-red-200">
                                    <i class="fas fa-trash mr-1"></i>Remover
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="font-medium text-sm text-gray-700">Distribuição por Centro:</h4>
                            <template x-for="center in costCenters" :key="center.id">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="h-3 w-3 rounded-full mr-2" 
                                             :style="'background-color: ' + getCenterColor(center.id)"></div>
                                        <span class="text-sm" x-text="center.name"></span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm font-medium" x-text="employee.distribution[center.id] + '%'"></span>
                                        <span class="text-xs text-gray-500" 
                                              x-text="formatCurrency(employee.salary * employee.distribution[center.id] / 100)"></span>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Total Validation -->
                            <div class="pt-2 border-t">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium">Total:</span>
                                    <span class="text-sm font-bold" 
                                          :class="getTotalEmployeePercentage(employee) === 100 ? 'text-green-600' : 'text-red-600'"
                                          x-text="getTotalEmployeePercentage(employee) + '%'"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- History View -->
        <div x-show="currentView === 'history'" class="space-y-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold">Histórico Mensal</h2>
                    <p class="text-gray-600">Análise histórica geral e por centro de custo</p>
                </div>
                <div class="flex space-x-2">
                    <button @click="historyView = 'summary'" 
                            :class="historyView === 'summary' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'"
                            class="px-4 py-2 rounded-lg font-medium transition-colors border">
                        <i class="fas fa-chart-bar mr-2"></i>Resumo Geral
                    </button>
                    <button @click="historyView = 'centers'" 
                            :class="historyView === 'centers' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'"
                            class="px-4 py-2 rounded-lg font-medium transition-colors border">
                        <i class="fas fa-building mr-2"></i>Por Centro
                    </button>
                </div>
            </div>

            <!-- Summary History -->
            <div x-show="historyView === 'summary'" class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 bg-gray-50 border-b">
                    <h3 class="text-lg font-semibold">Resumo Histórico Geral</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mês/Ano</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendas Totais</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Compras</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Custos Fixos</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mão de Obra</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Custos Totais</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lucro/Prejuízo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Margem %</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="record in history" :key="record.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="record.period"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium" x-text="formatCurrency(record.sales)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600" x-text="formatCurrency(record.purchases || 0)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-600" x-text="formatCurrency(record.fixedCosts || 0)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600" x-text="formatCurrency(record.laborCosts || 0)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium" x-text="formatCurrency(record.costs)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold" 
                                        :class="record.profit >= 0 ? 'text-green-600' : 'text-red-600'"
                                        x-text="formatCurrency(record.profit)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm" 
                                        :class="record.profit >= 0 ? 'text-green-600' : 'text-red-600'"
                                        x-text="((record.profit / record.sales) * 100).toFixed(1) + '%'"></td>
                                </tr>
                            </template>
                            <tr x-show="history.length === 0">
                                <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                    <i class="fas fa-calendar-times text-4xl mb-4 text-gray-300"></i>
                                    <p>Nenhum histórico disponível. Feche o primeiro mês para começar o histórico.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Centers History -->
            <div x-show="historyView === 'centers'" class="space-y-6">
                <template x-for="center in costCenters" :key="center.id">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 border-b">
                            <div class="flex items-center">
                                <div class="h-4 w-4 rounded-full mr-3" 
                                     :style="'background-color: ' + getCenterColor(center.id)"></div>
                                <h3 class="text-lg font-semibold" x-text="'Histórico - ' + center.name"></h3>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Período</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendas</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Compras</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">C. Fixos</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">M. Obra</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Resultado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Margem</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <template x-for="record in history" :key="record.id">
                                        <tr class="hover:bg-gray-50" x-show="record.centers && record.centers[center.id]">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="record.period"></td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600" 
                                                x-text="formatCurrency(record.centers[center.id]?.sales || 0)"></td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-red-600" 
                                                x-text="formatCurrency(record.centers[center.id]?.purchases || 0)"></td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-orange-600" 
                                                x-text="formatCurrency(record.centers[center.id]?.fixedCosts || 0)"></td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-blue-600" 
                                                x-text="formatCurrency(record.centers[center.id]?.laborCost || 0)"></td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium" 
                                                :class="(record.centers[center.id]?.profit || 0) >= 0 ? 'text-green-600' : 'text-red-600'"
                                                x-text="formatCurrency(record.centers[center.id]?.profit || 0)"></td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm" 
                                                :class="(record.centers[center.id]?.profit || 0) >= 0 ? 'text-green-600' : 'text-red-600'"
                                                x-text="(((record.centers[center.id]?.profit || 0) / (record.centers[center.id]?.sales || 1)) * 100).toFixed(1) + '%'"></td>
                                        </tr>
                                    </template>
                                    <tr x-show="history.length === 0">
                                        <td colspan="7" class="px-4 py-8 text-center text-gray-500 text-sm">
                                            Nenhum histórico para este centro
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Center Edit Modal -->
        <div x-show="showCenterModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" 
             @click.self="showCenterModal = false">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-full overflow-y-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold" x-text="'Gerenciar ' + (editingCenter?.name || '')"></h3>
                    <button @click="showCenterModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" x-show="editingCenter">
                    <!-- Compras -->
                    <div>
                        <h4 class="font-semibold mb-3">Compras</h4>
                        <div class="space-y-2">
                            <template x-for="(purchase, index) in editingCenter.purchases" :key="index">
                                <div class="flex items-center space-x-2">
                                    <input type="text" x-model="purchase.category" 
                                           class="flex-1 px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                                           placeholder="Categoria">
                                    <input type="number" x-model="purchase.value" 
                                           class="w-24 px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                                           placeholder="Valor">
                                    <button @click="editingCenter.purchases.splice(index, 1)" 
                                            class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </template>
                            <button @click="editingCenter.purchases.push({category: '', value: 0})" 
                                    class="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-600 hover:border-gray-400">
                                <i class="fas fa-plus mr-2"></i>Adicionar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Custos Fixos -->
                    <div>
                        <h4 class="font-semibold mb-3">Custos Fixos</h4>
                        <div class="space-y-2">
                            <template x-for="(cost, index) in editingCenter.fixedCosts" :key="index">
                                <div class="flex items-center space-x-2">
                                    <input type="text" x-model="cost.description" 
                                           class="flex-1 px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                                           placeholder="Descrição">
                                    <input type="number" x-model="cost.value" 
                                           class="w-24 px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                                           placeholder="Valor">
                                    <button @click="editingCenter.fixedCosts.splice(index, 1)" 
                                            class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </template>
                            <button @click="editingCenter.fixedCosts.push({description: '', value: 0})" 
                                    class="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-600 hover:border-gray-400">
                                <i class="fas fa-plus mr-2"></i>Adicionar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Vendas -->
                    <div>
                        <h4 class="font-semibold mb-3">Vendas</h4>
                        <div class="space-y-2">
                            <template x-for="(sale, index) in editingCenter.sales" :key="index">
                                <div class="flex items-center space-x-2">
                                    <input type="text" x-model="sale.description" 
                                           class="flex-1 px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                                           placeholder="Produto">
                                    <input type="number" x-model="sale.value" 
                                           class="w-24 px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                                           placeholder="Valor">
                                    <button @click="editingCenter.sales.splice(index, 1)" 
                                            class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </template>
                            <button @click="editingCenter.sales.push({description: '', value: 0})" 
                                    class="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-600 hover:border-gray-400">
                                <i class="fas fa-plus mr-2"></i>Adicionar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex space-x-4">
                    <button @click="saveCenterChanges()" 
                            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        Salvar Alterações
                    </button>
                    <button @click="showCenterModal = false" 
                            class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Employee Distribution Modal -->
        <div x-show="showDistributionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" 
             @click.self="showDistributionModal = false">
            <div class="bg-white rounded-lg max-w-2xl w-full p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">
                        Editar Distribuição - <span x-text="editingEmployeeDistribution?.name || ''"></span>
                    </h3>
                    <button @click="showDistributionModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div x-show="editingEmployeeDistribution" class="space-y-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">Salário Base:</span>
                            <span class="text-lg font-bold text-green-600" 
                                  x-text="formatCurrency(editingEmployeeDistribution?.salary || 0)"></span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h4 class="font-semibold">Distribuição Percentual por Centro:</h4>
                        <template x-for="center in costCenters" :key="center.id">
                            <div class="bg-white border rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <div class="h-4 w-4 rounded-full mr-3" 
                                             :style="'background-color: ' + getCenterColor(center.id)"></div>
                                        <span class="font-medium" x-text="center.name"></span>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <input type="range" 
                                               :value="editingEmployeeDistribution?.distribution[center.id] || 0"
                                               @input="updateEmployeeDistribution(center.id, parseInt($event.target.value))"
                                               min="0" max="100" 
                                               class="w-32">
                                        <div class="w-20">
                                            <input type="number" 
                                                   :value="editingEmployeeDistribution?.distribution[center.id] || 0"
                                                   @input="updateEmployeeDistribution(center.id, parseInt($event.target.value))"
                                                   min="0" max="100" 
                                                   class="w-full px-2 py-1 border rounded text-center">
                                        </div>
                                        <span class="text-sm">%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Valor Alocado:</span>
                                    <span class="font-medium text-green-600" 
                                          x-text="formatCurrency((editingEmployeeDistribution?.salary || 0) * (editingEmployeeDistribution?.distribution[center.id] || 0) / 100)"></span>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">Total da Distribuição:</span>
                            <span class="text-lg font-bold" 
                                  :class="getTotalEmployeePercentage(editingEmployeeDistribution) === 100 ? 'text-green-600' : 'text-red-600'"
                                  x-text="getTotalEmployeePercentage(editingEmployeeDistribution) + '%'"></span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1" 
                           x-show="getTotalEmployeePercentage(editingEmployeeDistribution) !== 100">
                            A soma deve ser exatamente 100%
                        </p>
                    </div>

                    <div class="flex space-x-4">
                        <button @click="saveEmployeeDistribution()" 
                                :disabled="getTotalEmployeePercentage(editingEmployeeDistribution) !== 100"
                                :class="getTotalEmployeePercentage(editingEmployeeDistribution) === 100 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'"
                                class="flex-1 text-white px-6 py-2 rounded transition-colors">
                            Salvar Distribuição
                        </button>
                        <button @click="showDistributionModal = false" 
                                class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function costManagement() {
            return {
                currentView: 'dashboard',
                historyView: 'summary',
                showCenterModal: false,
                showDistributionModal: false,
                editingCenter: null,
                editingEmployeeDistribution: null,
                editingEmployeeIndex: null,
                
                costCenters: [
                    {
                        id: 'emporio',
                        name: 'Empório',
                        purchases: [
                            { category: 'PROTEINA', value: 5000 },
                            { category: 'GERAIS', value: 5000 },
                            { category: 'HORTIFRUTI', value: 2000 }
                        ],
                        fixedCosts: [
                            { description: 'ÁGUA', value: 500 },
                            { description: 'ENERGIA', value: 800 },
                            { description: 'EMBALAGENS', value: 50 }
                        ],
                        sales: [
                            { description: 'X', value: 25000 },
                            { description: 'Y', value: 100 },
                            { description: 'Z', value: 50 }
                        ]
                    },
                    {
                        id: 'salgado',
                        name: 'Café Salgado',
                        purchases: [
                            { category: 'PROTEINA', value: 5000 },
                            { category: 'GERAIS', value: 5000 },
                            { category: 'HORTIFRUTI', value: 2000 }
                        ],
                        fixedCosts: [
                            { description: 'ÁGUA', value: 500 },
                            { description: 'ENERGIA', value: 800 },
                            { description: 'EMBALAGENS', value: 20 }
                        ],
                        sales: [
                            { description: 'X', value: 22000 },
                            { description: 'Y', value: 100 },
                            { description: 'Z', value: 50 }
                        ]
                    },
                    {
                        id: 'cafe',
                        name: 'Café',
                        purchases: [
                            { category: 'PROTEINA', value: 5000 },
                            { category: 'GERAIS', value: 5000 },
                            { category: 'HORTIFRUTI', value: 2000 }
                        ],
                        fixedCosts: [
                            { description: 'ÁGUA', value: 500 },
                            { description: 'ENERGIA', value: 800 },
                            { description: 'EMBALAGENS', value: 10 }
                        ],
                        sales: [
                            { description: 'X', value: 12000 },
                            { description: 'Y', value: 100 },
                            { description: 'Z', value: 50 }
                        ]
                    },
                    {
                        id: 'restaurante',
                        name: 'Restaurante',
                        purchases: [
                            { category: 'PROTEINA', value: 5000 },
                            { category: 'GERAIS', value: 5000 },
                            { category: 'HORTIFRUTI', value: 2000 }
                        ],
                        fixedCosts: [
                            { description: 'ÁGUA', value: 500 },
                            { description: 'ENERGIA', value: 800 },
                            { description: 'EMBALAGENS', value: 15 }
                        ],
                        sales: [
                            { description: 'X', value: 35000 },
                            { description: 'Y', value: 100 },
                            { description: 'Z', value: 50 }
                        ]
                    }
                ],
                
                employees: [
                    {
                        name: 'FULANO',
                        salary: 12000,
                        distribution: { emporio: 25, salgado: 25, cafe: 25, restaurante: 25 }
                    },
                    {
                        name: 'CICLANO',
                        salary: 20000,
                        distribution: { emporio: 25, salgado: 25, cafe: 25, restaurante: 25 }
                    }
                ],
                
                history: JSON.parse(localStorage.getItem('costHistory') || '[]'),
                
                formatCurrency(value) {
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value || 0);
                },
                
                getCurrentMonth() {
                    return new Date().toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                },
                
                getTotalSales() {
                    return this.costCenters.reduce((total, center) => 
                        total + center.sales.reduce((sum, sale) => sum + (sale.value || 0), 0), 0);
                },
                
                getTotalCosts() {
                    return this.getTotalPurchases() + this.getTotalFixedCosts();
                },

                getTotalPurchases() {
                    return this.costCenters.reduce((total, center) => 
                        total + center.purchases.reduce((sum, purchase) => sum + (purchase.value || 0), 0), 0);
                },

                getTotalFixedCosts() {
                    return this.costCenters.reduce((total, center) => 
                        total + center.fixedCosts.reduce((sum, cost) => sum + (cost.value || 0), 0), 0);
                },
                
                getTotalLaborCost() {
                    return this.employees.reduce((total, emp) => total + (emp.salary || 0), 0);
                },
                
                getProfit() {
                    return this.getTotalSales() - this.getTotalCosts() - this.getTotalLaborCost();
                },
                
                getCenterSales(center) {
                    return center.sales.reduce((sum, sale) => sum + (sale.value || 0), 0);
                },
                
                getCenterPurchases(center) {
                    return center.purchases.reduce((sum, purchase) => sum + (purchase.value || 0), 0);
                },
                
                getCenterFixedCosts(center) {
                    return center.fixedCosts.reduce((sum, cost) => sum + (cost.value || 0), 0);
                },
                
                getCenterLaborCost(center) {
                    return this.employees.reduce((total, emp) => 
                        total + ((emp.salary || 0) * (emp.distribution[center.id] || 0) / 100), 0);
                },
                
                getCenterTotalCosts(center) {
                    return this.getCenterPurchases(center) + this.getCenterFixedCosts(center) + this.getCenterLaborCost(center);
                },

                getCenterProfit(center) {
                    return this.getCenterSales(center) - this.getCenterTotalCosts(center);
                },

                getCenterMargin(center) {
                    const sales = this.getCenterSales(center);
                    return sales > 0 ? (this.getCenterProfit(center) / sales) * 100 : 0;
                },

                getCenterColor(centerId) {
                    const colors = {
                        'emporio': '#3B82F6',      // Blue
                        'salgado': '#10B981',      // Green  
                        'cafe': '#F59E0B',        // Orange
                        'restaurante': '#8B5CF6'   // Purple
                    };
                    return colors[centerId] || '#6B7280';
                },

                getTotalEmployeePercentage(employee) {
                    if (!employee) return 0;
                    return Object.values(employee.distribution).reduce((sum, percent) => sum + (percent || 0), 0);
                },
                
                editCenter(center) {
                    this.editingCenter = JSON.parse(JSON.stringify(center));
                    this.showCenterModal = true;
                },
                
                saveCenterChanges() {
                    const index = this.costCenters.findIndex(c => c.id === this.editingCenter.id);
                    if (index !== -1) {
                        this.costCenters[index] = this.editingCenter;
                    }
                    this.showCenterModal = false;
                    this.saveToStorage();
                },
                
                addEmployee() {
                    const name = prompt('Nome do funcionário:');
                    const salary = parseFloat(prompt('Salário base:') || '0');
                    if (name && salary > 0) {
                        this.employees.push({
                            name,
                            salary,
                            distribution: { emporio: 25, salgado: 25, cafe: 25, restaurante: 25 }
                        });
                        this.saveToStorage();
                    }
                },
                
                editEmployee(index) {
                    const emp = this.employees[index];
                    const newSalary = parseFloat(prompt('Novo salário:', emp.salary) || emp.salary);
                    emp.salary = newSalary;
                    this.saveToStorage();
                },
                
                editEmployeeDistribution(index) {
                    this.editingEmployeeIndex = index;
                    this.editingEmployeeDistribution = JSON.parse(JSON.stringify(this.employees[index]));
                    this.showDistributionModal = true;
                },

                updateEmployeeDistribution(centerId, percentage) {
                    if (this.editingEmployeeDistribution) {
                        this.editingEmployeeDistribution.distribution[centerId] = Math.max(0, Math.min(100, percentage || 0));
                    }
                },

                saveEmployeeDistribution() {
                    if (this.editingEmployeeIndex !== null && this.getTotalEmployeePercentage(this.editingEmployeeDistribution) === 100) {
                        this.employees[this.editingEmployeeIndex] = this.editingEmployeeDistribution;
                        this.showDistributionModal = false;
                        this.editingEmployeeDistribution = null;
                        this.editingEmployeeIndex = null;
                        this.saveToStorage();
                    }
                },

                removeEmployee(index) {
                    if (confirm('Remover funcionário?')) {
                        this.employees.splice(index, 1);
                        this.saveToStorage();
                    }
                },
                
                closeMonth() {
                    if (confirm('Fechar mês atual? Isso irá zerar os dados para o próximo mês.')) {
                        // Prepare center-specific data
                        const centers = {};
                        this.costCenters.forEach(center => {
                            centers[center.id] = {
                                sales: this.getCenterSales(center),
                                purchases: this.getCenterPurchases(center),
                                fixedCosts: this.getCenterFixedCosts(center),
                                laborCost: this.getCenterLaborCost(center),
                                profit: this.getCenterProfit(center)
                            };
                        });

                        const record = {
                            id: Date.now(),
                            period: this.getCurrentMonth(),
                            sales: this.getTotalSales(),
                            purchases: this.getTotalPurchases(),
                            fixedCosts: this.getTotalFixedCosts(),
                            laborCosts: this.getTotalLaborCost(),
                            costs: this.getTotalCosts() + this.getTotalLaborCost(),
                            profit: this.getProfit(),
                            centers: centers,
                            date: new Date().toISOString()
                        };
                        
                        this.history.unshift(record);
                        localStorage.setItem('costHistory', JSON.stringify(this.history));
                        
                        // Reset current month data
                        this.costCenters.forEach(center => {
                            center.purchases = [
                                { category: 'PROTEINA', value: 0 },
                                { category: 'GERAIS', value: 0 },
                                { category: 'HORTIFRUTI', value: 0 }
                            ];
                            center.fixedCosts = [
                                { description: 'ÁGUA', value: 0 },
                                { description: 'ENERGIA', value: 0 },
                                { description: 'EMBALAGENS', value: 0 }
                            ];
                            center.sales = [
                                { description: 'X', value: 0 },
                                { description: 'Y', value: 0 },
                                { description: 'Z', value: 0 }
                            ];
                        });
                        
                        this.saveToStorage();
                        alert('Mês fechado com sucesso!');
                    }
                },
                
                saveToStorage() {
                    localStorage.setItem('costManagementData', JSON.stringify({
                        costCenters: this.costCenters,
                        employees: this.employees
                    }));
                },
                
                loadFromStorage() {
                    const stored = localStorage.getItem('costManagementData');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.costCenters = data.costCenters || this.costCenters;
                        this.employees = data.employees || this.employees;
                    }
                },
                
                init() {
                    this.loadFromStorage();
                    this.historyView = 'summary';
                }
            }
        }
    </script>
</body>
</html>